### Http缓存那些事

#### Http缓存是什么？

##### 定义


首先，http缓存是与http请求中一个概念，指的是: 当客户端向服务器发起http请求资源时，会先抵达浏览器缓存，如果浏览器有“要请求资源”的副本，就可以直接从浏览器缓存中提取而不是从原始服务器中提取这个资源。

从这概念上解析可以看出，如果浏览器有缓存的资源副本才有可能进行缓存机制的运行，所以http缓存都是从第二次请求开始的。第一次请求资源时，服务器返回资源，并在respone header头中回传资源的缓存参数；第二次请求时，浏览器判断这些请求参数而执行缓存策略，

浏览器HTTP缓存可以分为强缓存和协商缓存。强缓存和协商缓存最大也是最根本的区别是：强缓存命中的话不会发请求到服务器（比如chrome中的200 from memory cache），协商缓存一定会发请求到服务器，通过资源的请求首部字段验证资源是否命中协商缓存，如果协商缓存命中，服务器会将这个请求返回，但是不会返回这个资源的实体，而是通知客户端可以从缓存中加载这个资源（304 not modified）。

#####  http缓存策略原理

http缓存策略机制如图所示，结合本图对http缓存策略做一个概括：

![](/Users/magic_wager/Desktop/屏幕快照 2019-06-21 下午5.31.06.png)

运行机制：

* 1.**第一次请求资源**时，浏览器本地是没有副本缓存的，此时会向服务器发起资源请求，然后服务器返回相应数据，同时会在http报文中返回协商缓存策略信息，比如返回Cache-Control、Expires、缓存时间、Etag、Last-Modified等信息（这些都是关于http缓存的信息,具体含义下文会有简要的说明）；
* 2.**第二次请求资源**时，浏览器有缓存的副本，此时会根据http报文中的请求头中的缓存相关信息（这些信息通常建立在服务器返回响应头中缓存相关信息）去决定缓存机制。
	* 首先判断是否有Cache-Control与Expires信息并且是否新鲜，如果有指定的保持新鲜的时间（**Cache-Control里max-age属性表示新鲜持续时间，Expires值为服务器的过期绝对时间**），并且还是新鲜的没有过期，则直接走**强缓存策略**，浏览器直接返回本地缓存的副本，并返回200http状态。
	* 如果Cache-Control指定为no-cache或者Cache-Control（或Expires不新鲜）不新鲜，则判断有无Etag值（第一次响应头可能携带的值）。
	* 如果有Etag，则向服务器发送请求，此请求报文头信息会携带**if-None-Match信息，其值为第一次响应头的Etag值**。服务器接受到请求，校验是否有更新，无更新则返回304http状态，告知浏览器使用本地缓存的副本即可（**协商缓存策略**）；有更新则返回最新的数据，并返回200http状态；
	* 如果无Etag,则再判断是否有Last_Modified；
	* 如果有Last_Modified,则向服务器发送请求，此请求报文头信息会携带**if-Modified-Since信息，其值为第一次响应头的Last-Modified值**。服务器接受到请求，校验是否有更新，无更新则返回304http状态，告知浏览器使用本地缓存的副本即可（**协商缓存策略**）；有更新则返回最新的数据，并返回200http状态；
	* 如果没有Last_Modified,则向服务器发送请求，服务器响应数据。

注意的点：

* 1.http缓存只能缓存get请求响应的资源，对于其他类型的响应则无能为力。
* 2.Expires值为服务器的过期绝对时间，当浏览器本地时间和服务器端时间相差过大,会出现缓存读取失效的情况。
* 3.有没有不走缓存的网站？有，大名鼎鼎的知乎就是，在Cache-Control里面设置不支持硬盘存储的no-store字段。



#### 为什么要使用Http缓存？
减少延迟加快网页打开速度、重复利用资源减少网络带宽消耗、降低请求次数或者减少传输内容从而减轻服务器压力
#### 怎么使用Http缓存？




命中强缓存就直接200，否则就把请求参数加到request header头中传给服务器，看是否命中协商缓存，命中则返回304，否则服务器会返回新的资源。
#### 总结
