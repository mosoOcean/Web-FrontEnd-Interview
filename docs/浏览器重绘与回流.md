### 浏览器重绘与回流

#### 定义

1. 当render tree中的一部分(或全部)因为元素的规模尺寸，布局，隐藏等改变而需要重新构建。这就称为回流（也称为重排）。每个页面至少需要一次回流，就是在页面第一次加载的时候。

2. 当render tree中的一些元素需要更新属性，而这些属性只是影响元素的外观，风格，而不会影响布局的，比如background-color。则就叫称为重绘。

注：回流必将引起重绘，而重绘不一定会引起回流。

#### 哪些属性的改变会导致回流，哪些导致重绘？

###### 导致回流的操作：

* 页面首次渲染
* 浏览器窗口大小发生改变
* 元素尺寸或位置发生改变
* 元素内容变化（文字数量或图片大小等等）
* 元素字体大小变化
* 添加或者删除**可见的DOM元素**
* 激活CSS伪类（例如：:hover）
* 查询某些属性或调用某些方法
	* 盒子模型相关属性
	* 定位属性及浮动

###### 导致重绘的操作：

* 文字颜色改变
* 背景颜色、背景图片改变
* visibility控制的隐藏与显示
* 边框的样式改变等


#### 怎么尽量避免回流（重排）

首先，现代浏览器会对频繁的回流或重绘操作进行优化：

浏览器会维护一个队列，把所有引起回流和重绘的操作放入队列中，如果队列中的任务数量或者时间间隔达到一个阈值的，浏览器就会将队列清空，进行一次批处理，这样可以把多次回流和重绘变成一次。

但是，当你访问以下属性或方法时，浏览器会立刻清空队列：

clientWidth、clientHeight、clientTop、clientLeft

offsetWidth、offsetHeight、offsetTop、offsetLeft

scrollWidth、scrollHeight、scrollTop、scrollLeft

width、height

getComputedStyle()
getBoundingClientRect()

所以，要尽量避免这些属性的查询频次。

###### CSS

* 避免使用table布局。(需要多次计算，时间多)
* 将动画效果应用到position属性为absolute或fixed的元素上。
* 避免使用CSS表达式（例如：calc()）。

###### JavaScript
* 避免频繁操作样式，**最好一次性重写style属性**，或者将样式列表定义为class并一次性更改class属性。
* 避免频繁操作DOM，创建一个**documentFragment**，在它上面应用所有DOM操作，最后再把它添加到文档中。
* 也可以**先为元素设置display: none**，操作结束后再把它显示出来。因为在display属性为none的元素上进行的DOM操作不会引发回流和重绘。
* 避免**频繁读取会引发回流/重绘的属性**，如果确实需要多次使用，就用一个变量缓存起来。
* 对具有**复杂动画的元素使用绝对定位**，使它脱离文档流，否则会引起父元素及后续元素频繁回流。








